;(function(win,doc){
var ENV = {"BrandID":3107,"CookieID":"OrjgA5oL8maH","PluginName":"car","Prod":true,"WebsiteID":36};
var isSafari13,DBG_Mode,DBG_CBSign,EndPointPath,ObserveInterval,LabelCollectInterval,LabelType,Payload;if(ENV,isSafari13=function(){var ua=navigator.userAgent.toLowerCase(),safari=ua.indexOf('safari')!==-1&&ua.indexOf('chrome')===-1,version=parseInt((ua.match(/version\/(\d+)/)||[0,0])[1],10);return safari&&version>=13}(),window.__ws_cb_tracker||isSafari13)return;window.__ws_cb_tracker=!0,DBG_Mode=ENV.Prod===!1,DBG_CBSign='CB-Site-Tracker:',EndPointPath='https://cbdp'+(DBG_Mode?'-dev':'')+'.contobox.com',ObserveInterval=100,LabelCollectInterval=2e3,window.__cb_SID='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:r&3|8;return v.toString(16)}).replace(/\-/g,''),LabelType={CATEGORY:'category',RELATED_CATEGORY:'related category',PRODUCT:'product',PRODUCT_BRAND:'product brand',PRODUCT_SKU:'product sku',CONTENT:'content',ADDED_TO_CART:'add to cart',STATE_MAKE_MODEL:'state make model',STORE_ID:'store id'},Payload={websiteID:ENV.WebsiteID,cbUserID:ENV.CookieID,aamUserID:'',brandID:ENV.BrandID,sid:window.__cb_SID,timeSpent:null,url:null,labels:null};function main(){SiteTracker()}function SiteTracker(){var o=Object.assign({},{init:function(){var ua,iOS,pageunload;return log('init site tracking'),this.observeTimer=0,this.isSent=!1,this.observing=!1,this.href=win.location.href.split('#')[0],this.TimeSpent=TimeSpentTracker(),this.Labels=LabelCollector(),this.Plugin=SitePlugin(this),this.DSPTracker=DSPTracker(this.TimeSpent),this.handleLocationChange=this.handleLocationChange.bind(this),this.handlePageUnload=this.handlePageUnload.bind(this),ua=navigator.userAgent,iOS=ua.match(/iPad/i)||ua.match(/iPhone/i),pageunload=iOS?'pagehide':'beforeunload',win.addEventListener(pageunload,this.handlePageUnload,!1),this.startObserving(),this},startObserving:function(){if(this.observing)return!1;log('start observing');var lbCt=0;return this.observeTimer=win.setInterval(function(){var href=win.location.href.split('#')[0];if(this.href!==href){this.handleLocationChange(href);return}lbCt+=ObserveInterval,lbCt>=LabelCollectInterval&&(this.Plugin.collect(this.Labels),this.DSPTracker.timespentMatched(),this.DSPTracker.ruleMatched(this.Labels.get()),lbCt=0)}.bind(this),ObserveInterval),this.observing=!0,this.Labels.on('update',this.DSPTracker.ruleMatched.bind(this.DSPTracker)),!0},stopObserving:function(){return!!this.observing&&(log('stop observing'),win.clearInterval(this.observeTimer),this.Plugin.collect(this.Labels),this.observing=!1,this.Labels.off('update',this.DSPTracker.ruleMatched.bind(this.DSPTracker)),!0)},send:function(){var labels,timeSpent,payload;return this.isSent?(log('send:','data is already sent'),!1):(labels=this.Labels.get(),!labels.length)?(log('send:','no labels'),!1):(timeSpent=this.TimeSpent.timeSpent(),payload=Object.assign({},Payload,{timeSpent,url:this.href,labels}),log('send:',JSON.stringify(payload,null,2)),sendBeacon(EndPointPath+'/wslabel',payload,function(queued){queued?log('send:','the user activity is queued to send.'):log('send:','the user activity failed to queue.')}),this.isSent=!0,!0)},handleLocationChange:function(href){log('location changed to:',href),this.stopObserving(),this.send(),this.TimeSpent.reset(),this.Labels.reset(),this.href=href,this.isSent=!1,this.startObserving()},handlePageUnload:function(){log('page unload'),this.stopObserving(),this.send()}});return o.init()}Observable={__calls:[],on:function(when,fn){this.__calls.push({when,fn})},off:function(when,fn){this.__calls=this.__calls.filter(function(c){return c.when!==when&&c.fn!==fn})},trigger:function(when,data){var context=this;this.__calls.forEach(function(c){c.when===when&&c.fn.call(context,data)})}};function LabelCollector(){var store={};return Object.assign({},Observable,{add:function(type,label){if(isArray(label)||(label=[label]),label=label.map(function(lb){return/number|string/.test(typeof lb)||(lb=''),String(lb).trim()}),label=label.filter(function(lb){return lb!==''}),!label.length)return;return label.forEach(function(lb){type in store||(store[type]=[]),store[type].indexOf(lb)===-1&&store[type].push(lb)}),this.trigger('update',this.get()),this},get:function(){var labels=[];return Object.keys(store).forEach(function(key){labels.push({type:key,values:store[key]})}),labels},reset:function(){store={},this.trigger('update',this.get()),this.trigger('reset')}})}function TimeSpentTracker(){var timeSpent=0,startTime=0,duration=0,lastEventTime=0,MIN_INT_DURATION=1e3,EVENT_TIMEOUT=8e3,isIElt10=/MSIE [8-9]/.test(navigator.userAgent),visPref=function(){var prefixes=['webkit','moz','ms','o'],i;if('hidden'in doc)return'';for(i=0;i<prefixes.length;i++)if(prefixes[i]+'Hidden'in doc)return prefixes[i];return''}(),visEvent=visPref+'visibilitychange',o=Object.assign({},{init:function(){return log('init time-spent tracking'),this.handleInteraction=this.handleInteraction.bind(this),this.handleFocusOut=this.handleFocusOut.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),doc.addEventListener('mousemove',this.handleInteraction,!1),doc.addEventListener('touchmove',this.handleInteraction,!1),doc.addEventListener('click',this.handleInteraction,!1),doc.addEventListener('touchend',this.handleInteraction,!1),win.addEventListener('scroll',this.handleInteraction,!1),win.addEventListener('mousewheel',this.handleInteraction,!1),win.addEventListener('DOMMouseScroll',this.handleInteraction,!1),doc.addEventListener(visEvent,this.handleVisibilityChange,!1),isIElt10?doc.addEventListener('focusout',this.handleFocusOut,!1):win.addEventListener('blur',this.handleFocusOut,!1),this},handleFocusOut:function(){this.updateTimeSpent()},handleVisibilityChange:function(){var hidden=(visPref===''?'h':visPref+'H')+'idden';typeof doc[hidden]!='undefined'&&doc[hidden]===!1&&this.updateTimeSpent()},handleInteraction:function(){var time=Date.now();startTime>0&&(time-lastEventTime>EVENT_TIMEOUT?this.updateTimeSpent():duration=time-startTime),startTime===0&&(startTime=time,duration=0),lastEventTime=time},updateTimeSpent:function(){return startTime>0&&(this.addTimeSpent(Math.max(MIN_INT_DURATION,duration)),startTime=duration=0),this},addTimeSpent:function(time){return timeSpent+=time,this},timeSpent:function(ms){return startTime>0&&this.updateTimeSpent(),ms?timeSpent:Math.max(1,Math.round(timeSpent/1e3))},reset:function(){timeSpent=0}});return o.init()}function DSPTracker(TimeSpent){function strnormalize(s){return s.toLowerCase().trim().replace(/[^a-zA-ZÀ-ÖØ-öø-ÿ0-9]+/g,'_').replace(/^_|_$/g,'')}var d=Object.assign({},{TimeSpent,ruleMatched:function(labels){this.data.rules.map(function(label){var labelArray,labelValues,timeSpent,matchedBrackets;label.matched&&!label.called?(Object.assign(label,{called:!0}),this.callTags(label.tracker)):typeof label.rule!='undefined'&&Object.keys(label.rule).length>0&&label.rule.segments!=='undefined'&&(labelArray=labels.map(function(l){return strnormalize(l.type)}),labelValues=[],timeSpent=this.TimeSpent.timeSpent(),matchedBrackets=Object.keys(this.data.brackets).filter(function(b){return timeSpent>=this.data.brackets[b]}.bind(this)),matchedBrackets.indexOf(label.bracket)!==-1&&label.rule.segments.map(function(segment){labelArray.indexOf(segment.name)!==-1&&(labelValues=labels.filter(function(l){return strnormalize(l.type)===segment.name})[0].values.map(function(v){return strnormalize(v)}),segment.values.map(function(s){labelValues.indexOf(s)!==-1&&!label.called&&(Object.assign(label,{called:!0}),this.callTags(label.tracker))}.bind(this)))}.bind(this)))}.bind(this))},timespentMatched:function(){var timeSpent=this.TimeSpent.timeSpent(),brackets=Object.keys(this.data.brackets).filter(function(b){return timeSpent>=this.data.brackets[b]}.bind(this)),unmatched=this.data.rules.filter(function(r){return r.matched===!1&&Object.keys(r.rule).length===0});if(!unmatched.length||!brackets.length)return;unmatched.forEach(function(u){var mb=u.bracket==='*'||!!brackets.filter(function(b){return u.bracket===b}).length;mb&&(Object.assign(u,{called:!0,matched:!0}),this.callTags(u.tracker))}.bind(this))},manageClientTriggers:function(type,value){this.data.rules.map(function(label){var This=this,clientTriggers,clientValues,called;if(label.called||typeof label.rule.client_triggers=='undefined')return;clientTriggers=label.rule.client_triggers.map(function(t){return t.name}),clientValues=label.rule.client_triggers.filter(function(t){return t.name===type}),clientTriggers.indexOf(type)!==-1&&(called=!1,clientValues.length>0&&clientValues.map(function(cv){cv.values&&cv.values.length>0&&value?cv.values.map(function(v){v===value&&!called&&(This.callTags(label.tracker),called=!0,Object.assign(label,{called:!0}))}):(This.callTags(label.tracker),called=!0,Object.assign(label,{called:!0}))}))}.bind(this))},callTags:function(tracker){var ts,t,tf;typeof tracker!='undefined'&&(ts=parseInt((new Date).getTime()/1e3,10),t=tracker.replace('[timestamp]',ts),tf=document.createElement('iframe'),tf.id='cbox-fn-'+ts,tf.src='',tf.setAttribute('width',1),tf.setAttribute('height',1),tf.setAttribute('frameborder','no'),tf.setAttribute('scrolling','no'),tf.style.display='none',document.body.appendChild(tf),tf.contentWindow.document.open('text/html','replace'),tf.contentWindow.document.write('<!DOCTYPE html><html><head></head><body>'+t+'</body></html>'),tf.contentWindow.document.close())},init:function(){var _t,xhttp;if(this.loading||this.ready)return;return this.loading=!0,_t=this,xhttp=new XMLHttpRequest,xhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200)try{_t.data=JSON.parse(xhttp.responseText),_t.data.brackets=_t.data.brackets||{},_t.data.rules=_t.data.rules||[],_t.ready=!0,_t.loading=!1,_t.callTags()}catch(ignore){}},xhttp.open('GET',EndPointPath+'/wsrule?website_id='+ENV.WebsiteID+'&brand_id='+ENV.BrandID+'&cb_user_id='+ENV.CookieID,!0),xhttp.send(),this}});return window.__cb_dsp_tracker=d,d.init()}function sendBeacon(url,params,callback){var queued=navigator.sendBeacon(url,JSON.stringify(params||{}));callback&&callback(queued)}function isArray(obj){return Object.prototype.toString.call(obj)==='[object Array]'}function callCBtracker(src){var ts=parseInt((new Date).getTime()/1e3,10),s='<script type="text/javascript">document.write(\'<iframe src="'+src+'" width="1" height="1" frameborder="0" style="display:none"></iframe>\');<\/script><noscript><iframe src="'+src+'" width="1" height="1" frameborder="0" style="display:none"></iframe></noscript>',tf=document.createElement('iframe');tf.id='cbox-fn-'+ts,tf.setAttribute('width',1),tf.setAttribute('height',1),tf.setAttribute('frameborder','no'),tf.setAttribute('scrolling','no'),tf.style.display='none',document.body.appendChild(tf),tf.contentWindow.document.open('text/html','replace'),tf.contentWindow.document.write('<!DOCTYPE html><html><head></head><body>'+s+'</body></html>'),tf.contentWindow.document.close()}typeof Object.assign!='function'&&Object.defineProperty(Object,'assign',{value:function(target,varArgs){'use strict';var to,index,nextSource,nextKey;if(target===null||target===void 0)throw new TypeError('Cannot convert undefined or null to object');to=Object(target);for(index=1;index<arguments.length;index++)if(nextSource=arguments[index],nextSource!==null&&nextSource!==void 0)for(nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey]);return to},writable:!0,configurable:!0}),!function(t,e){e()}(0,function(){'use strict';function t(e){return(t='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&'function'==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?'symbol':typeof t})(e)}var e=function(t){return'string'==typeof t},n=function(t){return t instanceof Blob};(function(){'navigator'in this||(this.navigator={}),'function'!=typeof this.navigator.sendBeacon&&(this.navigator.sendBeacon=function(t,o){var i=this.event&&this.event.type,r='unload'===i||'beforeunload'===i,f='XMLHttpRequest'in this?new XMLHttpRequest:new ActiveXObject('Microsoft.XMLHTTP');f.open('POST',t,!r),f.withCredentials=!0,f.setRequestHeader('Accept','*/*'),e(o)?(f.setRequestHeader('Content-Type','text/plain;charset=UTF-8'),f.responseType='text'):n(o)&&o.type&&f.setRequestHeader('Content-Type',o.type);try{f.send(o)}catch(t){return!1}return!0}.bind(this))}).call('object'===('undefined'==typeof window?'undefined':t(window))?window:{})});function log(){if(!DBG_Mode)return;var args=[].map.call(arguments,function(arg){return arg});console.log.apply(console,[DBG_CBSign].concat(args))}function validateConversionArgs(args){var validItems=[];return!(!args.items||args.items.length===0)&&(!(args.items.forEach(function(item){item&&item.sku&&validItems.push(item)}),validItems.length===0))}function sendLabels(collector,labels){var ls=labels&&labels.length?labels:collector.get(),payload;ls.length&&(payload=Object.assign({},Payload,{timeSpent:500,url:window.location.href.split("#")[0],labels:ls}),sendBeacon(EndPointPath+"/wslabel",payload,function(queued){queued?log("send:","the user activity is queued to send."):log("send:","the user activity failed to queue.")}))}function prepareAndSendConversionPayload(collector,args){var total=0,qty=0,labels;args.items.forEach(function(item){item.sku&&(collector.add('conversion',item.sku),total=total+parseFloat(item.price),qty=qty+parseInt(item.qty))}),labels=collector.get(),labels.forEach(function(l){l.type==='conversion'&&(l.data={orderID:args.order_id?args.order_id:null,qty,total})}),sendLabels(collector,labels)}window&&(window.cbtag=function(event,args){var l=LabelCollector();switch(event){case'add_to_cart':args&&args.sku&&(l.add(LabelType.ADDED_TO_CART,args.sku),sendLabels(l),__cb_dsp_tracker&&__cb_dsp_tracker.manageClientTriggers&&typeof __cb_dsp_tracker.manageClientTriggers=='function'&&__cb_dsp_tracker.manageClientTriggers('ADD_TO_CART',args.sku));break;case'conversion':args&&validateConversionArgs(args)&&(prepareAndSendConversionPayload(l,args),__cb_dsp_tracker&&__cb_dsp_tracker.manageClientTriggers&&typeof __cb_dsp_tracker.manageClientTriggers=='function'&&__cb_dsp_tracker.manageClientTriggers('CONVERSION'));break;default:}},window.cbtagdata&&window.cbtagdata.length&&window.cbtagdata.forEach(function(d){window.cbtag(d.event,d.args)})),main();function SitePlugin(st){var catTracked=!1,addToCartTracked=!1,cartPageTracked=!1,o=Object.assign({},{init:function(tracker){return log('init site plugin `'+ENV.PluginName+'`'),st.Labels.on('reset',function(){catTracked=!1}),this},collect:function(labels){var u=window,carModel;function getProductId(url){return url.split('/')[4]}window.location.href.split('/')[3]==='vehicledetail'&&(carModel=window.diSetup.stockType+' '+window.diSetup.make+' '+window.diSetup.model,labels.add(LabelType.PRODUCT_SKU,getProductId(window.location.href)),labels.add(LabelType.STATE_MAKE_MODEL,carModel))}});return o.init()}
})(window, document);
